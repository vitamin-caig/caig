            ASC Screen Crusher

   Один из первых серьёзных экранных паке-
ров, ASCLZPAK  (1991)  определил  основные
идеи структуры большинства последующих фо-
рматов и соответствующих им депакеров.
   А  именно, хотя  данные  в файле пока и
лежат только байтами,но впервые реализова-
на довольно оптимальная последовательность
просмотра экрана - ломаными столбцами. При
этом экран логически разбивается на 3 тре-
ти и атрибуты,где атрибуты линейны,а трети
состоят из столбцов байт. Этот способ даёт
возможность сжатия незначительно хуже спо-
соба с полными столбцами, зато здесь проще
пересчёт линейной модели в реальный экран.

   Познакомим  читателя  с  идеей линейной
модели ZX экрана.
   Заключается она в том,что каждому адре-
су на экране взаимно однозначно соответст-
вует  виртуальный адрес в линейной модели,
причём  последовательность адресов экрана,
порождаемая  порядком  просмотра (в данном
случае - ломаными  столбцами)  выглядит на
линейной модели последовательностью подряд
идущих виртуальных адресов. Т.е.при после-
довательном  переборе  виртуальных адресов
линейной модели - адреса на реальном экра-
не  будут перебираться ломаными столбцами.
Разумеется, для  этого  нужно использовать
процедуры  пересчета виртуальных адресов в
реальные.
   Как правило, начальные адреса реального
и  виртуального  экранов  совпадают, чтобы
адреса атрибутов не пересчитывались.
   Вот как выглядит пересчёт экранного ад-
реса  из  виртуального в реальный по ASC'у
(страшновато,но примите во внимание,что он
первый!):
──────────────────────────────────────────
                LD A,H
                AND #58
                CP #58
                JR Z,atr
                LD C,A
                LD A,L
                AND 7
                OR C
                LD C,A
                ADD HL,HL
                ADD HL,HL
                LD A,H
                AND #1F
                LD H,A
                LD A,L
                AND #E0
                OR H
                LD L,A
                LD H,C
         atr
──────────────────────────────────────────
   Распаковщик  ASCLZPAK, согласно  тради-
ции,перемещаем и для этого настраивает три
пары  ячеек  программы  под текущий адрес.
Опасного использования стека нет.
   Перемещение  по экрану ведётся в реаль-
ных адресах, и для координации этого (нес-
тандартное  решение) применено 3 регистра-
счётчика:

  A' = 8·номер столбца + 3-номер трети;
  B' = строка внутри знакоместа;
  C' = номер ряда знакомест внутри трети.

   Упакованные данные располагаются непос-
редственно после программы.Формат простой:

%0bbbbHHH,LLLLLLLL - ссылка  назад,  disp=
 =HHHLLLLLLLL, puts=bbbb+3
%10000000 - конец файла
%10bbbbbb,байты -  bbbbbb  байт  взять  из
потока
%11bbbbbb,байт - повторить  байт  bbbbbb+3
 раз (можно повторить байт до 66 раз, т.е.
 больше, чем через ссылку)

                       подготовил А. Кодер
